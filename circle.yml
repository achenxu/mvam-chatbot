machine:
  environment:
    PG_URL: postgres://ubuntu@localhost/mvambot
    TEST_PG_URL: postgres://ubuntu@localhost/mvambot
    WFP_DATA_URL: http://vam.wfp.org/sites/data/WFPVAM_FoodPrices_18-05-2016.csv

dependencies:
  cache_directories:
    - "crystal-0.17.3-1"
  pre:
    - if [[ ! -e crystal-0.17.3-1 ]]; then wget https://github.com/crystal-lang/crystal/releases/download/0.17.3/crystal-0.17.3-1-linux-x86_64.tar.gz && tar xvfz crystal-0.17.3-1-linux-x86_64.tar.gz; fi
    - sudo ln -ns /home/ubuntu/mvam-chatbot/crystal-0.17.3-1/bin/crystal /usr/local/bin/crystal
  post:
    - sudo service postgresql stop 9.4
    - sudo sed -i "s/port = ..../port = 5432/g" /etc/postgresql/9.5/main/postgresql.conf
    - sudo cp -v /etc/postgresql/9.{4,5}/main/pg_hba.conf && sudo service postgresql restart 9.5
    - sudo su - postgres -c "echo \"CREATE USER ubuntu WITH PASSWORD '';\" | psql"
    - sudo su - postgres -c "echo \"CREATE DATABASE mvambot;\" | psql"
    - sudo su - postgres -c "echo \"GRANT ALL PRIVILEGES ON DATABASE mvambot TO ubuntu;\" | psql"
    - sudo su - postgres -c "echo \"ALTER USER ubuntu WITH SUPERUSER;\" | psql"

test:
  pre:
    - crystal deps
    - ./bin/micrate up
    - ./bin/load-prices
  override:
    - crystal spec
